<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listado de Alumnos por Curso - PROA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='listas_cursos.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="fondo"></div>
  <div class="overlay"></div>

  <!-- Navegaci√≥n Principal -->
  <nav class="nav-principal">
    <div class="nav-container">
      <button class="menu-toggle" id="menuToggle" onclick="toggleMenu()">
        <span class="menu-icon">‚ò∞</span>
        <span class="menu-text">Men√∫</span>
      </button>
      <div class="nav-dropdown" id="navDropdown">
        <div class="nav-menu-items">
          <a href="{{ url_for('perfil_estudiante') }}" class="nav-link">Mi Perfil</a>
          <a href="{{ url_for('listar_cursos') }}" class="nav-link active">Ver Cursos</a>
          <a href="{{ url_for('registrar_asistencia') }}" class="nav-link">Registrar Asistencia</a>
        </div>
        <div class="nav-separator"></div>
        <div class="nav-logout-container">
          <a href="{{ url_for('logout') }}" class="nav-link logout">Cerrar Sesi√≥n</a>
        </div>
      </div>
    </div>
  </nav>

  <header>
    <h1> Listado de Alumnos por Curso</h1>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-messages">
          {% for message in messages %}
            <div class="flash-message 
              {% if '‚úÖ' in message %} success 
              {% elif '‚ùå' in message %} error 
              {% elif '‚ÑπÔ∏è' in message %} info
              {% else %} warning {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="botonera-acciones">
      <a href="{{ url_for('registrar_asistencia') }}" class="btn-accion-principal">
        <span class="icono">üìù</span>
        Registrar Nueva Asistencia
      </a>
      <button onclick="mostrarFiltros()" class="btn-accion-principal">
        <span class="icono">üîç</span>
        Filtrar Estudiante
      </button>
      </div>
  </header>

  <!-- Panel de filtros -->
  <div id="panel-filtros" class="panel-filtros" style="display: none;">
    <div class="filtros-container">
      <h3>üîç Filtros de B√∫squeda</h3>
      
      <div class="filtros-row">
        <div class="filtro-group">
          <label for="buscar-nombre">Buscar por nombre/apellido:</label>
          <input type="text" id="buscar-nombre" placeholder="Ej: Juan, P√©rez, Barrionuevo...">
        </div>
        
        <div class="filtro-group">
          <label for="filtro-curso">Filtrar por curso:</label>
          <select id="filtro-curso">
            <option value="">Todos los cursos</option>
            <option value="1">1¬∞ A√±o</option>
            <option value="2">2¬∞ A√±o</option>
            <option value="3">3¬∞ A√±o</option>
            <option value="4">4¬∞ A√±o</option>
            <option value="5">5¬∞ A√±o</option>
            <option value="6">6¬∞ A√±o</option>
          </select>
        </div>
        
        <div class="filtro-group">
          <label for="ordenar-por">Ordenar por:</label>
          <select id="ordenar-por">
            <option value="apellido">Apellido</option>
            <option value="nombre">Nombre</option>
            <option value="curso">Curso</option>
          </select>
        </div>
      </div>
      
      <div class="filtros-botones">
        <button onclick="aplicarFiltros()" class="btn-filtrar">
          <span class="icono">üîç</span>
          Aplicar Filtros
        </button>
        <button onclick="limpiarFiltros()" class="btn-limpiar">
          <span class="icono">üóëÔ∏è</span>
          Limpiar
        </button>
        <button onclick="cerrarFiltros()" class="btn-cerrar">
          <span class="icono">‚ùå</span>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- LISTADO DE CURSOS CON ACORDE√ìN -->
<main class="cursos-container">
  <div class="grid-cursos">
    {% for numero in ['1','2','3','4','5','6'] %}
    <section class="card-curso" data-curso="{{ numero }}">
      <button class="accordion" onclick="toggleAccordion(this)">
        {{ numero }}¬∞ A√±o
      </button>
      <div class="panel">
        <ul class="lista-alumnos">
          {% for alumno in cursos.get(numero, []) %}
          <li class="alumno-item">
            <div class="alumno-info">
              <span class="alumno-nombre">{{ alumno.apellido or '' }} {{ alumno.nombre }}</span>
              {% if alumno.dni %}
                <span class="alumno-dni">DNI: {{ alumno.dni }}</span>
              {% endif %}
            </div>
            <div class="botones-alumno">
              <a class="btn-ver" href="{{ url_for('perfil_estudiante_publico', estudiante_id=alumno.id) }}">
                <span class="icono-btn">üëÅÔ∏è</span>
                Ver Perfil
              </a>
            </div>
          </li>
          {% else %}
          <li class="alumno-item"><span class="alumno-nombre">Sin alumnos cargados</span></li>
          {% endfor %}
        </ul>
      </div>
    </section>
    {% endfor %}
  </div>
</main>

  <!-- Modal eliminado (bot√≥n Info removido) -->

  <script>
    // Evitar m√∫ltiples peticiones simult√°neas
    let isFetching = false;
    // ===============================
    // FUNCIONES DE FILTROS
    // ===============================
    function mostrarFiltros() {
      const panelFiltros = document.getElementById('panel-filtros');
      panelFiltros.style.display = 'block';
    }

    function cerrarFiltros() {
      const panelFiltros = document.getElementById('panel-filtros');
      panelFiltros.style.display = 'none';
    }

    function limpiarFiltros() {
      document.getElementById('buscar-nombre').value = '';
      document.getElementById('filtro-curso').value = '';
      document.getElementById('ordenar-por').value = 'apellido';
      aplicarFiltros();
    }

    function aplicarFiltros() {
      if (isFetching) return; // ya hay una petici√≥n en curso
      const nombre = document.getElementById('buscar-nombre').value;
      const curso = document.getElementById('filtro-curso').value;
      const ordenar = document.getElementById('ordenar-por').value;
      
      isFetching = true;
      // Realizar la b√∫squeda mediante AJAX
      fetch('/buscar_estudiante', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          nombre: nombre,
          curso: curso,
          ordenar: ordenar
        })
      })
      .then(response => response.json())
      .then(data => {
        // Actualizar la vista con los resultados
        console.log('Respuesta /buscar_estudiante', data);
        actualizarListaEstudiantes(data);
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al buscar estudiantes');
      })
      .finally(() => {
        isFetching = false;
      });
    }

    function actualizarListaEstudiantes(data) {
      // Recorrer cada curso y actualizar su contenido
      for (const curso in data) {
        const panel = document.querySelector(`[data-curso="${curso}"] .lista-alumnos`);
        if (panel) {
          if (data[curso].length > 0) {
            panel.innerHTML = data[curso].map(alumno => `
              <li class="alumno-item">
                <div class="alumno-info">
                  <span class="alumno-nombre">${alumno.apellido || ''} ${alumno.nombre}</span>
                  ${alumno.dni ? `<span class="alumno-dni">DNI: ${alumno.dni}</span>` : ''}
                </div>
                <div class="botones-alumno">
                  <a class="btn-ver" href="/estudiante/${alumno.id}">
                    <span class="icono-btn">üëÅÔ∏è</span>
                    Ver Perfil
                  </a>
                </div>
              </li>
            `).join('');
          } else {
            panel.innerHTML = '<li class="alumno-item"><span class="alumno-nombre">Sin alumnos cargados</span></li>';
          }
        }
      }
    }

    // ===============================
    // FUNCIONES DE ACORDE√ìN
    // ===============================
    function toggleAccordion(button) {
      button.classList.toggle("active");
      const panel = button.nextElementSibling;
      const arrow = button.querySelector(".flecha");

      if (panel.classList.contains("show")) {
        panel.classList.remove("show");
        arrow.textContent = "‚ñº";
      } else {
        panel.classList.add("show");
        arrow.textContent = "‚ñ≤";
      }
    }

    // Modal y funciones de info eliminadas (no usadas en el proyecto)

    // ===============================
    // MEN√ö DESPLEGABLE
    // ===============================
    function toggleMenu() {
      const dropdown = document.getElementById('navDropdown');
      const toggle = document.getElementById('menuToggle');
      dropdown.classList.toggle('active');
      toggle.classList.toggle('active');
    }

    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('navDropdown');
      const toggle = document.getElementById('menuToggle');
      if (!toggle.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
        toggle.classList.remove('active');
      }
    });

    // Evento de botones Info eliminado (bot√≥n removido)
  </script>
</body>
</html>