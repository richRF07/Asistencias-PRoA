<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listado de Alumnos por Curso - PROA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='listas_cursos.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="fondo"></div>
  <div class="overlay"></div>

  <!-- Navegación Principal -->
  <nav class="nav-principal">
    <div class="nav-container">
      <a href="{{ url_for('perfil_estudiante') }}" class="nav-link">Mi Perfil</a>
      <a href="{{ url_for('listar_cursos') }}" class="nav-link active">Ver Cursos</a>
      <a href="{{ url_for('registrar_asistencia') }}" class="nav-link">Registrar Asistencia</a>
      <a href="{{ url_for('logout') }}" class="nav-link logout">Cerrar Sesión</a>
    </div>
  </nav>

  <header>
    <h1>📚 Listado de Alumnos por Curso</h1>
    
    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-messages">
          {% for message in messages %}
            <div class="flash-message 
              {% if '✅' in message %} success 
              {% elif '❌' in message %} error 
              {% elif 'ℹ️' in message %} info
              {% else %} warning {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    
    <!-- Botonera de acciones rápidas -->
    <div class="botonera-acciones">
      <a href="{{ url_for('registrar_asistencia') }}" class="btn-accion-principal">
        <span class="icono">📝</span>
        Registrar Nueva Asistencia
      </a>
      <button onclick="mostrarFiltros()" class="btn-accion-principal">
        <span class="icono">🔍</span>
        Filtrar Cursos
      </button>
      <a href="{{ url_for('cargar_estudiantes_4to') }}" class="btn-accion-principal">
        <span class="icono">📚</span>
        Cargar 4° Año
      </a>
    </div>
  </header>

  <!-- Panel de filtros -->
  <div id="panel-filtros" class="panel-filtros" style="display: none;">
    <div class="filtros-container">
      <h3>🔍 Filtros de Búsqueda</h3>
      
      <div class="filtros-row">
        <div class="filtro-group">
          <label for="buscar-nombre">Buscar por nombre/apellido:</label>
          <input type="text" id="buscar-nombre" placeholder="Ej: Juan, Pérez, Barrionuevo...">
        </div>
        
        <div class="filtro-group">
          <label for="filtro-curso">Filtrar por curso:</label>
          <select id="filtro-curso">
            <option value="">Todos los cursos</option>
            <option value="1">1° Año</option>
            <option value="2">2° Año</option>
            <option value="3">3° Año</option>
            <option value="4">4° Año</option>
            <option value="5">5° Año</option>
            <option value="6">6° Año</option>
          </select>
        </div>
        
        <div class="filtro-group">
          <label for="ordenar-por">Ordenar por:</label>
          <select id="ordenar-por">
            <option value="apellido">Apellido</option>
            <option value="nombre">Nombre</option>
            <option value="curso">Curso</option>
          </select>
        </div>
      </div>
      
      <div class="filtros-botones">
        <button onclick="aplicarFiltros()" class="btn-filtrar">
          <span class="icono">🔍</span>
          Aplicar Filtros
        </button>
        <button onclick="limpiarFiltros()" class="btn-limpiar">
          <span class="icono">🗑️</span>
          Limpiar
        </button>
        <button onclick="cerrarFiltros()" class="btn-cerrar">
          <span class="icono">❌</span>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <main class="cursos-container">
    <div class="grid-cursos">
      {% for numero in ['1','2','3','4','5','6'] %}
      <section class="card-curso">
        <h2>{{ numero }}° Año</h2>
        <ul class="lista-alumnos">
          {% for alumno in cursos.get(numero, []) %}
          <li class="alumno-item">
            <div class="alumno-info">
              <span class="alumno-nombre">{{ alumno.apellido or '' }} {{ alumno.nombre }}</span>
              {% if alumno.dni %}
                <span class="alumno-dni">DNI: {{ alumno.dni }}</span>
              {% endif %}
            </div>
            <div class="botones-alumno">
              <a class="btn-ver" href="{{ url_for('perfil_estudiante_publico', estudiante_id=alumno.id) }}">
                <span class="icono-btn">👁️</span>
                Ver Perfil
              </a>
              <button class="btn-info" data-estudiante-id="{{ alumno.id }}">
                <span class="icono-btn">ℹ️</span>
                Info
              </button>
            </div>
          </li>
          {% else %}
          <li class="alumno-item"><span class="alumno-nombre">Sin alumnos cargados</span></li>
          {% endfor %}
        </ul>
      </section>
      {% endfor %}
    </div>
  </main>

  <!-- Modal para información del alumno -->
  <div id="modal-info" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h3>Información del Estudiante</h3>
      <div id="info-contenido"></div>
    </div>
  </div>

  <script>
    // Función para mostrar información del alumno
    function mostrarInfoAlumno(estudianteId) {
      // Aquí podrías hacer una petición AJAX para obtener más información
      // Por ahora mostraremos información básica
      const modal = document.getElementById('modal-info');
      const contenido = document.getElementById('info-contenido');
      
      if (!modal || !contenido) {
        console.error('Modal o contenido no encontrado');
        return;
      }
      
      contenido.innerHTML = `
        <p><strong>ID:</strong> ${estudianteId}</p>
        <p><strong>Estado:</strong> Activo</p>
        <p><strong>Última asistencia:</strong> Reciente</p>
        <p><strong>Acciones disponibles:</strong></p>
        <ul>
          <li>Ver perfil completo</li>
          <li>Ver historial de asistencias</li>
          <li>Registrar nueva asistencia</li>
        </ul>
      `;
      
      modal.style.display = 'block';
    }
    
    // Función para cerrar el modal
    function cerrarModal() {
      const modal = document.getElementById('modal-info');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Función para mostrar/ocultar filtros
    function mostrarFiltros() {
      const panel = document.getElementById('panel-filtros');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth' });
      } else {
        panel.style.display = 'none';
      }
    }
    
    function cerrarFiltros() {
      document.getElementById('panel-filtros').style.display = 'none';
    }
    
    // Función para aplicar filtros
    function aplicarFiltros() {
      const buscarNombre = document.getElementById('buscar-nombre').value.toLowerCase();
      const filtroCurso = document.getElementById('filtro-curso').value;
      const ordenarPor = document.getElementById('ordenar-por').value;
      
      // Obtener todas las tarjetas de curso
      const cardsCursos = document.querySelectorAll('.card-curso');
      let totalMostrados = 0;
      
      cardsCursos.forEach(card => {
        const cursoNumero = card.querySelector('h2').textContent.replace('° Año', '');
        const listaAlumnos = card.querySelector('.lista-alumnos');
        const alumnos = listaAlumnos.querySelectorAll('.alumno-item');
        let alumnosVisibles = 0;
        
        // Filtrar por curso
        if (filtroCurso && cursoNumero !== filtroCurso) {
          card.style.display = 'none';
          return;
        } else {
          card.style.display = 'block';
        }
        
        // Filtrar y ordenar alumnos
        const alumnosArray = Array.from(alumnos);
        
        // Filtrar por nombre/apellido
        const alumnosFiltrados = alumnosArray.filter(alumno => {
          const nombreCompleto = alumno.querySelector('.alumno-nombre').textContent.toLowerCase();
          const dni = alumno.querySelector('.alumno-dni') ? alumno.querySelector('.alumno-dni').textContent.toLowerCase() : '';
          
          if (!buscarNombre) return true;
          return nombreCompleto.includes(buscarNombre) || dni.includes(buscarNombre);
        });
        
        // Ordenar alumnos
        alumnosFiltrados.sort((a, b) => {
          const nombreA = a.querySelector('.alumno-nombre').textContent.toLowerCase();
          const nombreB = b.querySelector('.alumno-nombre').textContent.toLowerCase();
          
          switch(ordenarPor) {
            case 'nombre':
              return nombreA.localeCompare(nombreB);
            case 'curso':
              return cursoNumero.localeCompare(cursoNumero);
            default: // apellido
              return nombreA.localeCompare(nombreB);
          }
        });
        
        // Mostrar/ocultar alumnos
        alumnosArray.forEach(alumno => {
          if (alumnosFiltrados.includes(alumno)) {
            alumno.style.display = 'flex';
            alumnosVisibles++;
          } else {
            alumno.style.display = 'none';
          }
        });
        
        // Mostrar mensaje si no hay alumnos visibles
        const mensajeSinAlumnos = card.querySelector('.sin-alumnos');
        if (mensajeSinAlumnos) {
          mensajeSinAlumnos.remove();
        }
        
        if (alumnosVisibles === 0) {
          const mensaje = document.createElement('li');
          mensaje.className = 'sin-alumnos';
          mensaje.innerHTML = '<span class="alumno-nombre">No se encontraron estudiantes</span>';
          listaAlumnos.appendChild(mensaje);
        }
        
        totalMostrados += alumnosVisibles;
      });
      
      // Mostrar resumen de resultados
      mostrarResumenFiltros(totalMostrados, buscarNombre, filtroCurso);
    }
    
    // Función para limpiar filtros
    function limpiarFiltros() {
      document.getElementById('buscar-nombre').value = '';
      document.getElementById('filtro-curso').value = '';
      document.getElementById('ordenar-por').value = 'apellido';
      
      // Mostrar todos los alumnos y cursos
      const cardsCursos = document.querySelectorAll('.card-curso');
      cardsCursos.forEach(card => {
        card.style.display = 'block';
        const alumnos = card.querySelectorAll('.alumno-item');
        alumnos.forEach(alumno => {
          alumno.style.display = 'flex';
        });
        
        // Remover mensaje de sin alumnos
        const mensajeSinAlumnos = card.querySelector('.sin-alumnos');
        if (mensajeSinAlumnos) {
          mensajeSinAlumnos.remove();
        }
      });
      
      // Limpiar resumen
      const resumen = document.getElementById('resumen-filtros');
      if (resumen) {
        resumen.remove();
      }
    }
    
    // Función para mostrar resumen de filtros
    function mostrarResumenFiltros(total, busqueda, curso) {
      // Remover resumen anterior
      const resumenAnterior = document.getElementById('resumen-filtros');
      if (resumenAnterior) {
        resumenAnterior.remove();
      }
      
      // Crear nuevo resumen
      const resumen = document.createElement('div');
      resumen.id = 'resumen-filtros';
      resumen.className = 'resumen-filtros';
      
      let textoResumen = `🔍 Mostrando ${total} estudiante${total !== 1 ? 's' : ''}`;
      if (busqueda) textoResumen += ` que contienen "${busqueda}"`;
      if (curso) textoResumen += ` del curso ${curso}°`;
      
      resumen.innerHTML = `
        <div class="resumen-content">
          <span class="resumen-texto">${textoResumen}</span>
          <button onclick="limpiarFiltros()" class="btn-limpiar-resumen">Limpiar filtros</button>
        </div>
      `;
      
      // Insertar después del header
      const header = document.querySelector('header');
      header.insertAdjacentElement('afterend', resumen);
    }
    
    // Función para filtrar cursos (placeholder)
    function filtrarCursos() {
      alert('Función de filtrado próximamente disponible');
    }
    
    // Cerrar modal al hacer clic fuera de él
    window.onclick = function(event) {
      const modal = document.getElementById('modal-info');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }
    
    // Mejorar la función onclick para usar data attributes
    document.addEventListener('DOMContentLoaded', function() {
      const infoButtons = document.querySelectorAll('.btn-info');
      infoButtons.forEach(button => {
        button.addEventListener('click', function() {
          const estudianteId = this.getAttribute('data-estudiante-id');
          if (estudianteId) {
            mostrarInfoAlumno(estudianteId);
          }
        });
      });
    });
  </script>
</body>
</html>

